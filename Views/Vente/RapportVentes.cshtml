@model IEnumerable<MyShop.Models.Vente>

@{
    ViewBag.Title = "Rapport des Ventes";
    Layout = "_Layout";
}

<div class="content-wrapper">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="page-title mb-0">Rapport des Ventes</h3>
        <a href="@Url.Action("Index", "Vente")" class="btn btn-outline-secondary btn-lg">
            Retour <i class="bi bi-arrow-left ms-1"></i>
        </a>
    </div>

    <!-- Filtre par date -->
    <form method="get" class="row mb-4 g-3">
        <div class="col-md-4">
            <label for="dateStart" class="form-label">Date Début</label>
            <input type="date" id="dateStart" name="dateStart" class="form-control" value="Request.Query["dateStart"]" />
        </div>
        <div class="col-md-4">
            <label for="dateEnd" class="form-label">Date Fin</label>
            <input type="date" id="dateEnd" name="dateEnd" class="form-control" value="Request.Query["dateEnd"]" />
        </div>
        <div class="col-md-4 d-flex align-items-end">
            <button type="submit" class="btn btn-primary btn-lg w-100">
                Filtrer <i class="bi bi-filter-circle ms-1"></i>
            </button>
        </div>
    </form>

    <!-- Tableau des ventes -->
    <div class="table-responsive">
        <table class="table table-bordered table-hover align-middle text-start">
            <thead class="table-dark text-center">
                <tr>
                    <th>#</th>
                    <th>Date Vente</th>
                    <th>Client</th>
                    <th>Montant Total (DA)</th>
                    <th>Détails</th>
                </tr>
            </thead>
            <tbody>
                @{
                    int index = 1;
                    double totalVentes = 0;
                }
                @foreach (var vente in Model.OrderByDescending(v => v.DateVente))
                {
                    totalVentes += vente.MontantTotal;
                    var collapseId = "collapse" + vente.Id;
                    <tr class="table-light vente-row">
                        <td class="text-center">@index</td>
                        <td>@vente.DateVente.ToString("dd/MM/yyyy HH:mm")</td>
                        <td>@vente.ClientNom</td>
                        <td class="text-end fw-bold">@vente.MontantTotal.ToString("F0") DA</td>
                        <td class="text-center">
                            <button class="btn btn-sm btn-info toggle-btn" type="button">
                                <span class="btn-text">Voir</span> <i class="bi bi-eye ms-1"></i>
                            </button>
                        </td>
                    </tr>

                    <tr class="collapse">
                        <td colspan="5" class="p-0">
                            <table class="table table-sm table-borderless m-0 text-start">
                                <thead class="table-secondary text-center">
                                    <tr>
                                        <th>Produit</th>
                                        <th>Prix Unitaire (DA)</th>
                                        <th>Quantité</th>
                                        <th>Total (DA)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var detail in vente.VenteDetails)
                                    {
                                        <tr class="text-center produit-row">
                                            <td>@detail.ProduitNom</td>
                                            <td>@detail.PrixUnitaire.ToString("F0")</td>
                                            <td>@detail.Quantite</td>
                                            <td>@((detail.PrixUnitaire * detail.Quantite).ToString("F0"))</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </td>
                    </tr>
                    index++;
                }
            </tbody>
            <tfoot>
                <tr class="table-secondary text-end">
                    <th colspan="3">Total Général :</th>
                    <th colspan="2" class="fw-bold">@totalVentes.ToString("F0") DA</th>
                </tr>
            </tfoot>
        </table>
    </div>

    <!-- Bouton imprimer -->
    <div class="d-flex justify-content-end mt-3">
        <button class="btn btn-success" onclick="window.print();">
            Imprimer Rapport <i class="bi bi-printer ms-1"></i>
        </button>
    </div>
</div>

@section Styles {
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <style>
        .content-wrapper {
            max-width: 1300px;
            margin: 40px auto;
            padding: 30px 40px;
            background: #fff;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            direction: ltr;
        }

        table.table th, table.table td {
            vertical-align: middle;
        }

        .vente-row:hover {
            background-color: #d0f0fd !important;
        }

        .produit-row:hover {
            background-color: #e0f7fa !important;
        }

        .btn-primary, .btn-info, .btn-success {
            border-radius: 12px;
            font-weight: 600;
        }
    </style>
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const toggleButtons = document.querySelectorAll('.toggle-btn');
        const collapseRows = document.querySelectorAll('.collapse');

        toggleButtons.forEach((btn, idx) => {
            const collapseRow = collapseRows[idx];
            const collapseInstance = new bootstrap.Collapse(collapseRow, { toggle: false });
            const textSpan = btn.querySelector('.btn-text');
            const icon = btn.querySelector('i');

            btn.addEventListener('click', function () {
                if (collapseRow.classList.contains('show')) {
                    collapseInstance.hide();
                } else {
                    collapseInstance.show();
                }
            });

            collapseRow.addEventListener('shown.bs.collapse', function () {
                textSpan.textContent = 'Fermer';
                icon.className = 'bi bi-eye-slash ms-1';
            });

            collapseRow.addEventListener('hidden.bs.collapse', function () {
                textSpan.textContent = 'Voir';
                icon.className = 'bi bi-eye ms-1';
            });
        });
    </script>
}